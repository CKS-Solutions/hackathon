# Build and push to ECR: matrix over ms-auth, ms-video, ms-notify (paths → service).
# Context = ./packages, file = ./packages/<service>/Dockerfile. One var ECR_REGISTRY (prefix).
# workflow_dispatch or workflow file change → build all. Tags: github.sha + latest.

name: Build and Push to ECR

on:
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - 'packages/**'
      - '.github/workflows/build-push.yml'
  pull_request:
    branches: [master]

concurrency:
  group: build-push
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      services: ${{ steps.set-services.outputs.list }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Paths filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            ms-auth:
              - 'packages/ms-auth/**'
            ms-video:
              - 'packages/ms-video/**'
            ms-notify:
              - 'packages/ms-notify/**'
            workflow:
              - '.github/workflows/build-push.yml'

      - name: Set services to build
        id: set-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ steps.filter.outputs.workflow }}" = "true" ]; then
            echo '["ms-auth","ms-video","ms-notify"]' > list.json
          else
            arr=()
            [ "${{ steps.filter.outputs.ms-auth }}" = "true" ] && arr+=("ms-auth")
            [ "${{ steps.filter.outputs.ms-video }}" = "true" ] && arr+=("ms-video")
            [ "${{ steps.filter.outputs.ms-notify }}" = "true" ] && arr+=("ms-notify")
            if [ ${#arr[@]} -eq 0 ]; then
              echo '[]' > list.json
            else
              printf '%s\n' "${arr[@]}" | jq -R . | jq -s -c . > list.json
            fi
          fi
          echo "list=$(cat list.json)" >> $GITHUB_OUTPUT
          cat list.json

  build:
    name: Build and push ${{ matrix.service }}
    needs: changes
    if: needs.changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.changes.outputs.services) }}
    permissions:
      id-token: write
      contents: read
    env:
      ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        uses: docker/build-push-action@v6
        with:
          context: ./packages
          file: ./packages/${{ matrix.service }}/Dockerfile
          load: true
          tags: ${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Tag and push to ECR
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          repo="${ECR_REGISTRY}/${{ matrix.service }}"
          docker tag "${{ matrix.service }}:${{ github.sha }}" "${repo}:${{ github.sha }}"
          docker tag "${{ matrix.service }}:${{ github.sha }}" "${repo}:latest"
          docker push "${repo}:${{ github.sha }}"
          docker push "${repo}:latest"

  update-image-tags:
    name: Update prod image tags in repo
    needs: [changes, build]
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tags in patch files
        run: |
          SHA="${{ github.sha }}"
          SERVICES='${{ needs.changes.outputs.services }}'
          for svc in $(echo "$SERVICES" | jq -r '.[]'); do
            case "$svc" in
              ms-auth)   f="infra/k8s/overlays/prod/patch-ms-auth-image.yaml" ;;
              ms-video)  f="infra/k8s/overlays/prod/patch-ms-video-image.yaml" ;;
              ms-notify) f="infra/k8s/overlays/prod/patch-ms-notify-image.yaml" ;;
              *) echo "Unknown service: $svc"; exit 1 ;;
            esac
            sed -i "s|image: .*/${svc}:.*|image: ${ECR_REGISTRY}/${svc}:${SHA}|" "$f"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/k8s/overlays/prod/patch-ms-*-image.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore(infra): update prod image tags to ${{ github.sha }}"
          git push origin master
