# Application para o stack de logs (Loki + Promtail).
# Aplicar após o Argo CD e, se desejado, após monitoring-stack: kubectl apply -f infra/k8s/argocd/application-loki.yaml
# O release é instalado no namespace monitoring; o Grafana (kube-prometheus-stack) deve ter datasource Loki configurado em application-monitoring.yaml.
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: loki-stack
    targetRevision: "2.10.3"
    helm:
      values: |
        # Não instalar Grafana (já temos no kube-prometheus-stack)
        grafana:
          enabled: false
        prometheus:
          enabled: false
        fluent-bit:
          enabled: false
        # Loki: single binary; persistence desabilitada para agendar sem PVC (cluster pode não ter StorageClass).
        # Para persistir logs, ative persistence e garanta um StorageClass no EKS (ex.: EBS CSI driver).
        loki:
          enabled: true
          persistence:
            enabled: false
          resources:
            requests:
              memory: 256Mi
              cpu: 100m
            limits:
              memory: 512Mi
              cpu: 500m
        # Promtail: coleta logs dos pods e envia para Loki
        promtail:
          enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
